# Базовая конфигурация - общие сервисы
# Использование:
#   Прод:  docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#   Dev:   docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d

services:
  bot:
    build: .
    command: ["python", "main.py", "--prod"]
    volumes:
      - bot_logs:/var/log
      - ./db.json:/app/db.json
      - telegram_data:/data:ro
      - ./data:/app/data:ro
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - DOWNLOAD_PROXY=${DOWNLOAD_PROXY}
      - TELEGRAM_API_PORT=${TELEGRAM_API_PORT}
      - TRANSLATE_KEY_ID=${TRANSLATE_KEY_ID}
      - TRANSLATE_KEY_SECRET=${TRANSLATE_KEY_SECRET}
      - SPEECHKIT_API_ID=${SPEECHKIT_API_ID}
      - SPEECHKIT_API_SECRET=${SPEECHKIT_API_SECRET}
      - EVELEN_LABS_STT=${EVELEN_LABS_STT}
      - AI_KEY_ID=${AI_KEY_ID}
      - AI_KEY_SECRET=${AI_KEY_SECRET}
      - AI_MODEL_URI=${AI_MODEL_URI}
      - AI_MODEL_YANDEXGPT_PASHA=${AI_MODEL_YANDEXGPT_PASHA}
      - AI_MODEL_YANDEXGPT_5_PRO=${AI_MODEL_YANDEXGPT_5_PRO}
      - AI_MODEL_GPT_OSS_20B=${AI_MODEL_GPT_OSS_20B}
      - AI_MODEL_LLAMA_70B=${AI_MODEL_LLAMA_70B}
      - DEEPSEEK_KEY=${DEEPSEEK_KEY}
      - TELEGRAM_API_ID=${TELEGRAM_API_ID}
      - TELEGRAM_API_HASH=${TELEGRAM_API_HASH}
      - TELEGRAM_API_HOST=http://telegram-api:8081
      - WEB_APP_URL=https://${DOMAIN}
      - METRICS_ENABLED=${METRICS_ENABLED:-false}
      - METRICS_PORT=${METRICS_PORT:-9090}
    depends_on:
      - telegram-api
    networks:
      - bot
    restart: always

  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    expose:
      - "5173"
    volumes:
      - ./web:/app
      - /app/node_modules
    networks:
      - bot
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - DOMAIN=${DOMAIN:-localhost}

  telegram-api:
    image: aiogram/telegram-bot-api:latest
    environment:
      TELEGRAM_HTTP_PORT: 8081
      TELEGRAM_LOCAL: ""
      TELEGRAM_WORK_DIR: "/data"
      TELEGRAM_API_ID: ${TELEGRAM_API_ID}
      TELEGRAM_API_HASH: ${TELEGRAM_API_HASH}
    volumes:
      - telegram_data:/data
    ports:
      - "${TELEGRAM_API_PORT:-8081}:8081"
    networks:
      - bot

  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.96.0
    container_name: victoriametrics
    profiles:
      - metrics
    command:
      - "-storageDataPath=/storage"
      - "-retentionPeriod=6"
      - "-promscrape.config=/etc/prometheus/prometheus.yml"
    volumes:
      - victoriametrics_data:/storage
      - ./monitoring/victoriametrics/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - bot
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.2.3
    container_name: grafana
    profiles:
      - metrics
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - bot
    depends_on:
      - victoriametrics
    restart: unless-stopped

volumes:
  telegram_data:
  bot_logs:
  victoriametrics_data:
  grafana_data:

networks:
  bot:
    driver: bridge
