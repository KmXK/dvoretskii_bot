# Базовая конфигурация - общие сервисы
# Использование:
#   Прод:  docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#   Dev:   docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d

services:
  bot:
    build: .
    command: ["python", "main.py", "--prod"]
    volumes:
      - bot_logs:/var/log
      - ./db.json:/app/db.json
      - telegram_data:/data:ro
      - ./data:/app/data:ro
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - DOWNLOAD_PROXY=${DOWNLOAD_PROXY}
      - TELEGRAM_API_PORT=${TELEGRAM_API_PORT}
      - TRANSLATE_KEY_ID=${TRANSLATE_KEY_ID}
      - TRANSLATE_KEY_SECRET=${TRANSLATE_KEY_SECRET}
      - SPEECHKIT_API_ID=${SPEECHKIT_API_ID}
      - SPEECHKIT_API_SECRET=${SPEECHKIT_API_SECRET}
      - EVELEN_LABS_STT=${EVELEN_LABS_STT}
      - AI_KEY_ID=${AI_KEY_ID}
      - AI_KEY_SECRET=${AI_KEY_SECRET}
      - AI_MODEL_URI=${AI_MODEL_URI}
      - AI_MODEL_YANDEXGPT_PASHA=${AI_MODEL_YANDEXGPT_PASHA}
      - AI_MODEL_YANDEXGPT_5_PRO=${AI_MODEL_YANDEXGPT_5_PRO}
      - AI_MODEL_GPT_OSS_20B=${AI_MODEL_GPT_OSS_20B}
      - AI_MODEL_LLAMA_70B=${AI_MODEL_LLAMA_70B}
      - OPENROUTER_KEY=${OPENROUTER_KEY}
      - DEEPSEEK_KEY=${DEEPSEEK_KEY}
      - TELEGRAM_API_ID=${TELEGRAM_API_ID}
      - TELEGRAM_API_HASH=${TELEGRAM_API_HASH}
      - TELEGRAM_API_HOST=http://telegram-api:8081
      - WEB_APP_URL=https://${DOMAIN}
      - METRICS_ENABLED=${METRICS_ENABLED:-false}
      - METRICS_PORT=${METRICS_PORT:-9090}
      - API_PORT=${API_PORT:-8080}
    expose:
      - "${API_PORT:-8080}"
    depends_on:
      - telegram-api
    networks:
      - bot
    restart: always

  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    expose:
      - "5173"
    volumes:
      - ./web:/app
      - /app/node_modules
    networks:
      - bot
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - DOMAIN=${DOMAIN:-localhost}

  telegram-api:
    image: aiogram/telegram-bot-api:latest
    environment:
      TELEGRAM_HTTP_PORT: 8081
      TELEGRAM_LOCAL: ""
      TELEGRAM_WORK_DIR: "/data"
      TELEGRAM_API_ID: ${TELEGRAM_API_ID}
      TELEGRAM_API_HASH: ${TELEGRAM_API_HASH}
    volumes:
      - telegram_data:/data
    ports:
      - "${TELEGRAM_API_PORT:-8081}:8081"
    networks:
      - bot

  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.96.0
    container_name: victoriametrics
    profiles:
      - metrics
    command:
      - "-storageDataPath=/storage"
      - "-retentionPeriod=18"
      - "-promscrape.config=/etc/prometheus/prometheus.yml"
    volumes:
      - victoriametrics_data:/storage
      - ./monitoring/victoriametrics/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - bot
    restart: unless-stopped

  vmbackup:
    image: victoriametrics/vmbackup:v1.96.0
    container_name: vmbackup
    profiles:
      - metrics
    volumes:
      - victoriametrics_data:/storage:ro
    environment:
      - AWS_ACCESS_KEY_ID=${YC_S3_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${YC_S3_KEY_SECRET}
      - BACKUP_INTERVAL=${BACKUP_INTERVAL:-24h}
      - S3_BUCKET=${YC_S3_BUCKET:-metrics-backup}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        if [ -z "$$AWS_ACCESS_KEY_ID" ] || [ -z "$$AWS_SECRET_ACCESS_KEY" ]; then
          echo "S3 credentials not configured (YC_S3_KEY_ID/YC_S3_KEY_SECRET). Backup disabled."
          exit 0
        fi
        echo "Waiting for VictoriaMetrics..."
        until wget -q --spider http://victoriametrics:8428/health 2>/dev/null; do
          echo "VM not ready, retrying in 5s..."
          sleep 5
        done
        echo "VictoriaMetrics is up"
        while true; do
          echo "Starting backup at $$(date)"
          if /vmbackup-prod \
            -storageDataPath=/storage \
            -snapshot.createURL=http://victoriametrics:8428/snapshot/create \
            -dst=s3://$$S3_BUCKET/vm-backup \
            -customS3Endpoint=https://storage.yandexcloud.net; then
            echo "Backup completed at $$(date). Sleeping for $$BACKUP_INTERVAL"
            sleep $$BACKUP_INTERVAL
          else
            echo "Backup failed at $$(date). Retrying in 60s..."
            sleep 60
          fi
        done
    depends_on:
      - victoriametrics
    networks:
      - bot
    restart: on-failure

  grafana:
    image: grafana/grafana:main-ubuntu
    container_name: grafana
    profiles:
      - metrics
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - bot
    depends_on:
      - victoriametrics
    restart: unless-stopped

volumes:
  telegram_data:
  bot_logs:
  victoriametrics_data:
  grafana_data:

networks:
  bot:
    driver: bridge
