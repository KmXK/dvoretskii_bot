# Dev конфигурация
# Использование: docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d
# С метриками: docker compose -f docker-compose.yml -f docker-compose.dev.yml --profile metrics up -d

services:
  bot:
    entrypoint: ["/bin/sh", "/scripts/wait-for-tunnel.sh"]
    command: ["python", "main.py", "--prod"]
    volumes:
      - ./scripts:/scripts:ro
      - tunnel-info:/shared
    depends_on:
      - localhost-run
    develop:
      watch:
        - action: sync+restart
          path: ./steward
          target: /app/steward
        - action: sync+restart
          path: ./main.py
          target: /app/main.py
    environment:
      - METRICS_ENABLED=${METRICS_ENABLED:-false}
    expose:
      - "${METRICS_PORT:-9090}"

  web:
    develop:
      watch:
        - action: sync
          path: ./web/src
          target: /app/src
        - action: rebuild
          path: ./web/package.json

  localhost-run:
    build:
      context: ./scripts
      dockerfile: Dockerfile.localhost-run
    environment:
      - LOCAL_PORT=5173
    volumes:
      - tunnel-info:/shared
    network_mode: "service:web"
    depends_on:
      - web
    restart: always
    healthcheck:
      test: ["CMD", "/healthcheck-tunnel.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  grafana:
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin

volumes:
  tunnel-info:
