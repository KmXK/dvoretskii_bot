# ะะฐะฑะพัะฐ ั ะะ

## ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         Handler                                 โ
โ  (ai_handler, pasha_handler, ...)                               โ
โ                                                                 โ
โ  register_ai_handler("name", ai_call)                           โ
โ  execute_ai_request(context, text, ai_call, "name")             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
              โโโโโโโโโโโโโโผโโโโโโโโโโโโโ
              โ     ai_context.py       โ
              โ                         โ
              โ  build_reply_context()  โโโโโ Telethon: ัะพะฑะธัะฐะตั
              โ  execute_ai_request()   โ     ัะตะฟะพัะบั ัะตะฟะปะฐะตะฒ
              โ  register/get_ai_handlerโ
              โโโโโโโโโโโโโโฌโโโโโโโโโโโโโ
                           โ
         โโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโ
         โผ                 โผ                 โผ
   AI-ะฟัะพะฒะฐะนะดะตัั (ai.py): Yandex, DeepSeek, OpenRouter
         โ                 โ                 โ
         โผ                 โผ                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              AiRelatedMessageHandler                โ
โ                                                     โ
โ  ะะพะฒะธั ัะตะฟะปะฐะธ ะฝะฐ ัะพะพะฑัะตะฝะธั ะฑะพัะฐ, ะพะฟัะตะดะตะปัะตั         โ
โ  ะฟัะพะฒะฐะนะดะตัะฐ ะฟะพ ะฟะพะปั handler ะฒ ai_messages,           โ
โ  ะฟัะพะดะพะปะถะฐะตั ะดะธะฐะปะพะณ ัะตัะตะท ัะพั ะถะต AI                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ะัะพะฒะฐะนะดะตัั

ะะฟัะตะดะตะปะตะฝั ะฒ `steward/helpers/ai.py`. ะะฐะถะดัะน ะฟัะพะฒะฐะนะดะตั โ ััะฝะบัะธั, ะบะพัะพัะฐั ะฟัะธะฝะธะผะฐะตั `user_id`, `messages` ะธ `system_prompt`, ะฒะพะทะฒัะฐัะฐะตั ัััะพะบั ะพัะฒะตัะฐ.

| ะัะพะฒะฐะนะดะตั | ะคัะฝะบัะธั | Async | ะัะธะผะตัะฐะฝะธะต |
|---|---|---|---|
| **Yandex GPT** | `make_yandex_ai_query` | ะดะฐ | ะกะฐะผัะน ะดะตััะฒัะน, ะธัะฟะพะปัะทัะน ะฟะพ ัะผะพะปัะฐะฝะธั |
| **OpenRouter** | `make_openrouter_query` | ะดะฐ | ะัะฑัะต ะผะพะดะตะปะธ, ัะพะดะธั ัะตัะตะท `DOWNLOAD_PROXY` |
| **DeepSeek** | `make_deepseek_query` | ะฝะตั | ะัะธะฝะธะผะฐะตั `text` ะฒะผะตััะพ `messages`, ะฝะต ะฟะพะดะดะตัะถะธะฒะฐะตั ะบะพะฝัะตะบัั ัะตะฟะปะฐะตะฒ |

ะะพัััะฟะฝัะต ะผะพะดะตะปะธ ะธ env-ะบะปััะธ โ ัะผ. ะบะปะฐััั `YandexModelTypes`, `OpenRouterModel` ะฒ `ai.py`.

## ะคะพัะผะฐั ัะพะพะฑัะตะฝะธะน

Yandex ะธ OpenRouter ะฟัะธะฝะธะผะฐัั `messages: list[tuple[str, str]]` โ ัะฟะธัะพะบ ะบะพััะตะถะตะน `(role, text)`:

```python
messages = [
    ("user", "ะัะธะฒะตั"),
    ("assistant", "ะะดะฐัะพะฒะฐ"),
    ("user", "ะะฐะบ ะดะตะปะฐ?"),
]
```

## ะัะพะผะฟัั

ะะตะถะฐั ะฒ `prompts/*.txt`. ะะฐะณััะถะฐัััั ะฟัะธ ััะฐััะต ัะตัะตะท `get_prompt()` ะฒ `ai.py` ะบะฐะบ ะบะพะฝััะฐะฝัั ะผะพะดัะปั.

ะงัะพะฑั ะดะพะฑะฐะฒะธัั ะฝะพะฒัะน: ัะพะทะดะฐะน ัะฐะนะป ะฒ `prompts/` ะธ ะดะพะฑะฐะฒั ะฒ `ai.py`:

```python
MY_PROMPT = get_prompt("ะธะผั_ัะฐะนะปะฐ")
```

## ะะพะฝัะตะบัั ัะตะฟะปะฐะตะฒ

`execute_ai_request` ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะพะฑะธัะฐะตั ะธััะพัะธั ะดะธะฐะปะพะณะฐ ะธะท ัะตะฟะพัะบะธ ัะตะฟะปะฐะตะฒ ะฒ ัะฐัะต.

### ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั

1. `build_reply_context()` ะฑะตััั ัะตะบััะตะต ัะพะพะฑัะตะฝะธะต ะธ ะธะดัั ะฟะพ ัะตะฟะพัะบะต `reply_to` ัะตัะตะท Telethon
2. ะะปั ะบะฐะถะดะพะณะพ ัะพะพะฑัะตะฝะธั ะพะฟัะตะดะตะปัะตั ัะพะปั: ะพั ะฑะพัะฐ โ `assistant`, ะธะฝะฐัะต โ `user`
3. ะัะปะธ ะฟััะผะพะณะพ ัะตะฟะปะฐั ะฝะตั, ะธัะตั ัะฒัะทั ัะตัะตะท `db.ai_messages` (ะผะฐะฟะฟะธะฝะณ ะพัะฒะตั ะฑะพัะฐ โ ะธััะพะดะฝะพะต ัะพะพะฑัะตะฝะธะต)
4. ะกะพะฑัะฐะฝะฝัะน ะบะพะฝัะตะบัั ะฟะตัะตะดะฐัััั ะฒ AI-ะฟัะพะฒะฐะนะดะตั

### ะฅัะฐะฝะตะฝะธะต ะฒ ะะ

ะะพัะปะต ะพัะฒะตัะฐ ะฑะพัะฐ ะฒ `db.ai_messages` ัะพััะฐะฝัะตััั `AiMessage` (`timestamp`, `message_id`, `handler`). ะะฐะบัะธะผัะผ 1000 ะทะฐะฟะธัะตะน, ััะฐััะต ะฒััะตัะฝััััั.

## ะะฐะบ ะฝะฐะฟะธัะฐัั ะฝะพะฒัะน AI-ัะตะฝะดะปะตั

1. ะกะพะทะดะฐะน ะฟัะพะผะฟั ะฒ `prompts/`, ะทะฐะณััะทะธ ะฒ `ai.py`
2. ะ ัะตะฝะดะปะตัะต ะฒัะทะพะฒะธ `register_ai_handler` ั ะธะผะตะฝะตะผ ะธ callable โ ััะพ ะฒะบะปััะธั ะฟัะพะดะพะปะถะตะฝะธะต ะดะธะฐะปะพะณะฐ ัะตัะตะท ัะตะฟะปะฐะธ
3. ะ ะผะตัะพะดะต `chat` ะฒัะทะพะฒะธ `execute_ai_request` ั ะฝัะถะฝัะผ ะฟัะพะฒะฐะนะดะตัะพะผ, ะฟัะพะผะฟัะพะผ ะธ ัะตะผ ะถะต ะธะผะตะฝะตะผ
4. ะะฐัะตะณะธัััะธััะน ัะตะฝะดะปะตั ะฒ `main.py`

`execute_ai_request` ะฑะตััั ะฝะฐ ัะตะฑั: ัะฑะพัะบั ะบะพะฝัะตะบััะฐ, ะฒัะทะพะฒ AI, ะพัะฟัะฐะฒะบั ะพัะฒะตัะฐ, ัะพััะฐะฝะตะฝะธะต ะฒ ะะ.

ะะตัะตัะตะฝัะฝัะต ะฟัะธะผะตัั: `ai_handler.py` (OpenRouter), `pasha_handler.py` (Yandex).

## AI Router (natural language โ ะบะพะผะฐะฝะดะฐ)

`AiRouterHandler` (`steward/handlers/ai_router_handler.py`) ะฟะพะทะฒะพะปัะตั ะฒัะฟะพะปะฝััั ะบะพะผะฐะฝะดั ะฑะพัะฐ ะฝะฐ ะตััะตััะฒะตะฝะฝะพะผ ัะทัะบะต.

### ะขัะธะณะณะตัั

ะกะพะพะฑัะตะฝะธะต ะดะพะปะถะฝะพ ะฝะฐัะธะฝะฐัััั ั ะพะดะฝะพะณะพ ะธะท:
- `@bot_username`
- `ะดะฒะพัะตัะบะธะน`
- `ัะฒะฐะถะฐะตะผัะน`
- ะพัะฒะตั (reply) ะฝะฐ ัะพะพะฑัะตะฝะธะต ะฑะพัะฐ ะธะปะธ ะฟะตัะตัะปะฐะฝะฝะพะต ัะพะพะฑัะตะฝะธะต ะฑะพัะฐ โ ััะธะณะณะตั-ัะปะพะฒะพ ะฝะต ะฝัะถะฝะพ

### ะัะธะผะตัั

ะัะพััะฐั ะบะพะผะฐะฝะดะฐ:
```
ัะฒะฐะถะฐะตะผัะน, ะฝะฐะฟะพะผะฝะธ ัะตัะตะท 10 ะผะธะฝัั ะฟะพะบะพัะผะธัั ะบะพัะฐ
โ ๐ค /remind 10m ะฟะพะบะพัะผะธัั ะบะพัะฐ  [โ ะัะฟะพะปะฝะธัั] [โ ะัะผะตะฝะฐ]
```

ะะตัะตัะปะฐะฝะฝะพะต ัะพะพะฑัะตะฝะธะต + ัะตะฟะปะฐะน:
```
[ะะตัะตัะปะฐะฝะฝะพะต: "ะัััะตัะฐ 25 ัะตะฒัะฐะปั ะฒ 10:00"]
โณ ะดะฒะพัะตัะบะธะน, ะฝะฐะฟะพะผะฝะธ
โ ๐ค /remind 25.02 10:00 ะัััะตัะฐ  [โ ะัะฟะพะปะฝะธัั] [โ ะัะผะตะฝะฐ]
```

ะะฐะฝ ะฟะพ ะฟะตัะตัะปะฐะฝะฝะพะผั ัะพะพะฑัะตะฝะธั:
```
[ะะตัะตัะปะฐะฝะฝะพะต ะพั @spammer: "ะบัะฟะธ ะฑะธัะบะพะธะฝ"]
โณ ะดะฒะพัะตัะบะธะน, ะทะฐะฑะฐะฝั ััะพะณะพ ัะตะปะพะฒะตะบะฐ ะฝะฐ 5 ะผะธะฝัั
โ ๐ค /ban @spammer 5m  [โ ะัะฟะพะปะฝะธัั] [โ ะัะผะตะฝะฐ]
```

ะะตัะบะพะปัะบะพ ะบะพะผะฐะฝะด:
```
ัะฒะฐะถะฐะตะผัะน, ะฝะฐะฟะพะผะฝะธ ัะตัะตะท ัะฐั ะธ ะดะพะฑะฐะฒั ะฒ ัะฟะธัะพะบ ะดะตะป: ะบัะฟะธัั ะผะพะปะพะบะพ
โ ๐ค /remind 1h ะบัะฟะธัั ะผะพะปะพะบะพ
     /todo ะบัะฟะธัั ะผะพะปะพะบะพ
  [โ ะัะฟะพะปะฝะธัั] [โ ะัะผะตะฝะฐ]
```

### ะะฐะบ ัะฐะฑะพัะฐะตั

1. ะะพะฒะธั ัะพะพะฑัะตะฝะธั ะฝะฐัะธะฝะฐััะธะตัั ั ััะธะณะณะตัะฐ ะธะปะธ ะพัะฒะตัั ะฝะฐ ัะพะพะฑัะตะฝะธั ะฑะพัะฐ (ะฝะต ะบะพะผะฐะฝะดั `/`)
2. ะัะปะธ ัะพะพะฑัะตะฝะธะต โ ัะตะฟะปะฐะน, ัะตะบัั ะธ ะธะฝัะพัะผะฐัะธั ะพะฑ ะพัะฟัะฐะฒะธัะตะปะต `reply_to_message` ะฟะตัะตะดะฐัััั LLM ะบะฐะบ ะบะพะฝัะตะบัั (ะฒะบะปััะฐั `forward_origin` ะดะปั ะฟะตัะตัะปะฐะฝะฝัั ัะพะพะฑัะตะฝะธะน). ะขะฐะฑะปะธัั ะดะพะปะณะพะฒ ะธะท ะพััััะพะฒ `/bill` ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟัะตะพะฑัะฐะทััััั ะฒ ัะตะบััะพะฒัะน ัะพัะผะฐั ยซX ะดะพะปะถะตะฝ Y: ััะผะผะฐยป ะดะปั ะบะพััะตะบัะฝะพะณะพ ะฟะฐััะธะฝะณะฐ
3. ะกะพะฑะธัะฐะตั `help()` ะฒัะตั ัะตะฝะดะปะตัะพะฒ โ ะบะฐัะฐะปะพะณ ะบะพะผะฐะฝะด
4. ะัะฟัะฐะฒะปัะตั ะฒ Yandex GPT: ะบะฐัะฐะปะพะณ + ะบะพะฝัะตะบัั + ะทะฐะฟัะพั ะฟะพะปัะทะพะฒะฐัะตะปั
5. LLM ะฒะพะทะฒัะฐัะฐะตั ะพะดะฝั ะธะปะธ ะฝะตัะบะพะปัะบะพ ะบะพะผะฐะฝะด (ะฟะพ ะพะดะฝะพะน ะฝะฐ ัััะพะบั)
6. ะะพั ะฟะพะบะฐะทัะฒะฐะตั ะบะพะผะฐะฝะดั ั ะบะฝะพะฟะบะฐะผะธ ะฟะพะดัะฒะตัะถะดะตะฝะธั
7. ะะพ ะฝะฐะถะฐัะธั โ โ ะฟะฐััะธั `message.text` ะธ `entities`, ะฒัะฟะพะปะฝัะตั ะบะพะผะฐะฝะดั ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพ
8. ะะพ ะฝะฐะถะฐัะธั โ โ ะพัะผะตะฝัะตั
9. ะัะปะธ LLM ะฝะต ะฝะฐััะป ะฟะพะดัะพะดัััั ะบะพะผะฐะฝะดั โ ะพัะฒะตัะฐะตั ัะตะบััะพะผ

### ะฅัะฐะฝะตะฝะธะต pending-ะบะพะผะฐะฝะด

ะะถะธะดะฐััะธะต ะฟะพะดัะฒะตัะถะดะตะฝะธั ะบะพะผะฐะฝะดั ััะฐะฝัััั in-memory ะฒ `_pending: dict[str, PendingExecution]`. ะะฐะบัะธะผัะผ 100 ะทะฐะฟะธัะตะน, ััะฐััะต ะฒััะตัะฝััััั. ะะต ะฟะตัะตะถะธะฒะฐัั ัะตััะฐัั ะฑะพัะฐ. ะะพะดัะฒะตัะดะธัั ะผะพะถะตั ัะพะปัะบะพ ะฐะฒัะพั ะทะฐะฟัะพัะฐ.

### ะะณัะฐะฝะธัะตะฝะธั

- ะกะตััะธะพะฝะฝัะต ัะตะฝะดะปะตัั (broadcast, reward add) ะผะพะณัั ัะฐะฑะพัะฐัั ะฝะตััะฐะฑะธะปัะฝะพ ัะตัะตะท ัะพััะตั
- ะะพะฝัะตะบัั `reply_to_message` ัะพััะฐะฝัะตััั (ะฟะพะปะตะทะฝะพ ะดะปั `/translate`, `/remind` ั ะฟะตัะตััะปะบะพะน)
- Admin-only ะบะพะผะฐะฝะดั ัะธะปัััััััั ะฟะพ ะฟะพะปัะทะพะฒะฐัะตะปั
- Rate limit: 15 req/min ะพะฑัะธะน, 5 req/30s ะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปั

### ะะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒัั ะบะพะผะฐะฝะด

ะะธะบะฐะบะธั ะดะตะนััะฒะธะน ะฝะต ะฝัะถะฝะพ โ ัะพััะตั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะพะดัะฒะฐััะฒะฐะตั `help()` ะฒัะตั ัะตะฝะดะปะตัะพะฒ.

## Rate limiting

ะัะต ะฟัะพะฒะฐะนะดะตัั ะพะณัะฐะฝะธัะตะฝั ัะตัะตะท `check_limit` ะธะท `steward/helpers/limiter.py`. ะัะธ ะฟัะตะฒััะตะฝะธะธ ะฑัะพัะฐะตััั `BucketFullException`, ะฑะพั ะพัะฒะตัะฐะตั "ะกะปะธัะบะพะผ ะผะฝะพะณะพ ะทะฐะฟัะพัะพะฒ".
