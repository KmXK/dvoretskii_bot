логика работы команды /bill:

/bill add добавление нового счета (сессия)
пользователь вводит название счета, которое по совместительству является именем файла в Google Drive в папке финансы
после этого бот ищет этот файл в гугл драйв и выдает "начальный отчет" по счету

/bill add {имя} — добавление счета одной командой (без сессии)

/bill all посмотреть все счета  - бот выдает список всех счетов с описанием

/bill {id} - посмотреть счет по id, бот выдает "отчет" по счету

/bill {id} debug - посмотреть счет по id с выводом сырых строк из Google таблицы для отладки

/bill pay {кто} {кому} {сумма} - бот добавляет перевод в базу данных с id без времени

/bill close {id1} {id2} ... - закрыть счета

/bill - бот выдает "общий отчет" по всем счетам

/bill help - бот выдает "помощь" по команде

/bill details add {пользователь} - добавление платежных данных для пользователя (сессия)
бот спрашивает описание платежных данных для пользователя

/bill details add {пользователь} {описание} — добавление платежных данных одной командой (имя — одно слово, остальное — описание)
также поддерживается многострочный формат (имя на первой строке после add, описание со второй строки)

/bill details edit {пользователь} - редактирование платежных данных для пользователя (сессия)

/bill details edit {пользователь} {описание} — редактирование одной командой (имя ищется среди существующих записей)
также поддерживается многострочный формат (имя на первой строке после edit, описание со второй строки)

"начальный отчет":
- блок кто кому сколько должен, или инструкция как закрыть счет если платежи закрывают все долги
- блок с платежными данными для пользователей которым должны(лишних не надо)
- ссылка на файл в гугл драйве

"отчет":
- блок кто кому сколько должен, или инструкция как закрыть счет если платежи закрывают все долги
- блок кто кому сколько должен из всех счетов, или инструкция как закрыть счет если платежи закрывают все долги
- блок с совершенными платежами, которые могут относиться к этому счету
- блок с платежными данными для пользователей которым должны(лишних не надо)
- ссылка на файл в гугл драйве

"общий отчет":
- блок кто кому сколько должен из всех счетов, или инструкция как закрыть счет если платежи закрывают все долги
- блок с совершенными платежами, которые могут относиться к этим счетам
- блок с платежными данными для пользователей которым должны(лишних не надо)
- панель навигации (inline keyboard):
  первый ряд: << < общий > >> (навигация по счетам, "общий" — возврат к общему отчету)
  второй ряд: id последних пяти счетов (быстрый доступ)
  при нажатии на кнопку сообщение редактируется и показывает соответствующий отчет
  навигация < > перемещает между счетами по id, с "общий" как крайней позицией
  текущая позиция отмечена символом •


для блока кто кому сколько должен используется алгоритм
попарная свертка только между прямыми парами (должник ↔ кредитор):
для каждой пары (A, B) считается разница: долг A→B минус долг B→A;
в отчёте остаётся один остаток в одну сторону (или ноль, если долги взаимно погасились);
перебрасывание долгов через третьих лиц не используется — учитываются только прямые пары.
если среди платежей найден платеж на сумму больше чем сумма долга в текущем счете, то долг становиться равен 0(не уходит в минус) (только для блоков для определенных счетов) (для блока для общего счета, долг переходит в отрицательный)
в начальном отчете не должны участвовать переводы вообще

инструкция должна включать прямую команду /bill close {id1} {id2} ... для закрытия счетов
при закрытии удаляются счета из базы данных и платежи их закрывающие, но если платеж на сумму больше чем долг, то остаток остается в базе данных и может быть использован для закрытия других счетов, надо не удалить платеж а уменьшить его

возможные ситуации:
по счету 1 А должен Б 10
по счету 2 Б должен А 5
платеж от А к Б на 5
и для счета 1, и для счета 2 должно быть помечено что А не должен Б 

формат данных в файле на гугл диске:
Наименование|Достоинство|Плательщик|Плательщик (фактический)
трактуется как:
_|сумма которую должны|кто должен|кому должен
кто должен может быть несколько через запятую

AI роутер — закрытие долгов через пересылку отчёта:
если пользователь отвечает на сообщение бота (или пересланное сообщение бота) и пишет что кто-то «заплатил по долгам» / «никому не должен» / «рассчитался»,
AI роутер генерирует несколько команд /bill pay для каждого долга этого человека.
ответ на сообщение бота автоматически активирует AI роутер без триггера «дворецкий»/«уважаемый».

закрытие долгов реализовано программно (без LLM):
роутер детектит паттерны «X заплатил по долгам», «X рассчитался», «X не должен» и т.п.,
парсит таблицу долгов из текста отчёта и генерирует /bill pay команды напрямую.
это гарантирует правильное направление (Должник → Кому) без ошибок LLM.

для остальных запросов контекст по-прежнему проходит через LLM, таблица долгов преобразуется
из табличного формата в текстовый «X должен Y: сумма» для лучшего понимания моделью.

вопросы по данным отчёта (например «сколько я должен», «кто должен Бете»)
не маппятся на /bill, а проксируются в /ai — AI отвечает на вопрос используя отчёт из reply chain